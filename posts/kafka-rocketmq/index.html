<!DOCTYPE html>
<head>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.png" />
<link rel="shortcut icon" type="image/png" href="/images/favicon.png" />

    
    
    <title>Kafka、RocketMQ调研 - 聽的资料</title>
    
    
    <meta name="author" content="sohunjug" /> 
     
    
    
    <meta name="keywords" content="Kafka, RocketMQ" />
    
    <meta property="og:title" content="Kafka、RocketMQ调研" />
<meta property="og:description" content="Kafka是Linkin开源的消息中间件
Kafka的设计目标是：

（1）以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间复杂度的访问性能。
（2）高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条以上消息的传输。
（3）支持Kafka Server间的消息分区，及分布式消费，同时保证每个Partition内的消息顺序传输。
（4）同时支持离线数据处理和实时数据处理。
（5）Scale out：支持在线水平扩展。

RocketMQ是阿里开源的消息中间件

其最初也是基于Kafka发展而来。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sohunjug.com/posts/kafka-rocketmq/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-08-08T09:10:28+08:00" />
<meta property="article:modified_time" content="2016-08-08T09:10:28+08:00" />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kafka、RocketMQ调研"/>
<meta name="twitter:description" content="Kafka是Linkin开源的消息中间件
Kafka的设计目标是：

（1）以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间复杂度的访问性能。
（2）高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条以上消息的传输。
（3）支持Kafka Server间的消息分区，及分布式消费，同时保证每个Partition内的消息顺序传输。
（4）同时支持离线数据处理和实时数据处理。
（5）Scale out：支持在线水平扩展。

RocketMQ是阿里开源的消息中间件

其最初也是基于Kafka发展而来。
"/>


    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqusjs.css" />
    
    

    
    
    <link rel="stylesheet" href="https://sohunjug.com/scss/main.min.3796779d99b798f0ae24d49c5a420db134eef2207610ed71453e417ce3ab44ed.css" integrity="sha256-N5Z3nZm3mPCuJNScWkINsTTu8iB2EO1xRT5BfOOrRO0=" crossorigin="anonymous" media="screen">
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
</head>
  
</head>
<body>
  <span class="mobile btn-mobile-menu">

    <i class="fa fa-list btn-mobile-menu__icon"></i>
    <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>

  </span>

  <header class="  panel-cover panel-cover--collapsed " style="background-image: url('/images/background-cover.jpg')">

    <div class="panel-main">
  
      <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">
  
          <a href="/#blog" title="Homepage of 聽的资料 " class="blog-button"><img src="/images/avatar.jpg" width="80" alt="聽的资料 logo" class="panel-cover__logo logo" /></a>
          <h1 class="panel-cover__title panel-title"><a href="/#blog" title="Homepage of 聽的资料" class="blog-button">聽的资料</a></h1>
          
          <span class="panel-cover__subtitle panel-subtitle">Opportunity favors only the prepared mind. And everything change with time.</span>
          
          <hr class="panel-cover__divider" />
          <p class="panel-cover__description"></p>
          <hr class="panel-cover__divider panel-cover__divider--secondary" />
          
          
          
          <div class="navigation-wrapper">
            <div>
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="/#blog" title="Blog" class="blog-button">Blog</a></li>
                  
                    <li class="navigation__item"><a href="/tags/" target="_blank" title="Tags">Tags</a></li>
                  
                </ul>
              </nav>
            </div>
            
            <div><nav class="cover-navigation navigation--social">
    <ul class="navigation">
  
    
    
    <li class="navigation__item">
      <a href="http://weibo.com/sohunjug" title="@sohunjug" target="_blank">
        <i class='social fa fa-weibo'></i>
        <span class="label">Weibo</span>
      </a>
    </li>
    
  
    
    
    <li class="navigation__item">
      <a href="https://github.com/sohunjug" title="@sohunjug" target="_blank">
        <i class='social fa fa-github'></i>
        <span class="label">Github</span>
      </a>
    </li>
    
    
    
    
    <li class="navigation__item">
      <a href="https://twitter.com/sohunjug" title="@sohunjug" target="_blank">
        <i class='social fa fa-twitter'></i>
        <span class="label">Twitter</span>
      </a>
    </li>
    

    
  
    
  
    
    <li class="navigation__item">
      <a href="/index.xml" rel="author" title="RSS" target="_blank">
        <i class='social fa fa-rss'></i>
        <span class="label">RSS</span>
      </a>
    </li>
  
    
    
    <li class="navigation__item">
      <a href="mailto:sohunjug@gmail.com" title="Contact me">
        <i class='social fa fa-envelope'></i>
        <span class="label">Email</span>
      </a>
    </li>
    
  
    </ul>
  </nav>
  </div>
          </div>
        </div>
      </div>
      
      
      <div class="panel-cover--overlay cover-red"></div>
      
    </div>
  </header>
  

  <div class="content-wrapper">
    <div class="content-wrapper__inner">

        
<article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <div class="post-meta">
            <time datetime=" 2016-08-08 09:10:28 &#43;0800 " itemprop="datePublished" class="post-meta__date date">2016-08-08</time>
             <span class="post-meta__tags tags">   • <a href="https://sohunjug.com/tags/kafka">Kafka</a>   • <a href="https://sohunjug.com/tags/rocketmq">RocketMQ</a>  </span> 
        </div>
        <h1 class="post-title">Kafka、RocketMQ调研</h1>
    </header>
    <section class="post">
        <h3 id="kafka是linkin开源的消息中间件">Kafka是Linkin开源的消息中间件</h3>
<h4 id="kafka的设计目标是">Kafka的设计目标是：</h4>
<blockquote>
<p>（1）以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间复杂度的访问性能。
（2）高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条以上消息的传输。
（3）支持Kafka Server间的消息分区，及分布式消费，同时保证每个Partition内的消息顺序传输。
（4）同时支持离线数据处理和实时数据处理。
（5）Scale out：支持在线水平扩展。</p>
</blockquote>
<h3 id="rocketmq是阿里开源的消息中间件">RocketMQ是阿里开源的消息中间件</h3>
<blockquote>
<p>其最初也是基于Kafka发展而来。</p>
</blockquote>
<h2 id="数据可靠性">数据可靠性</h2>
<ul>
<li>RocketMQ支持异步实时刷盘，同步刷盘，同步Replication，异步Replication</li>
<li>Kafka使用异步刷盘方式，异步Replication/同步Replication</li>
</ul>
<h2 id="性能对比">性能对比</h2>
<ul>
<li>Kafka会在Producer端将多个小消息合并，批量发向Broker，所以在批量发送消息时有着大量的优势，在批量时，Kafka单机写入TPS约在百万条/秒，消息大小100个字节</li>
<li>RocketMQ单机写入TPS单实例约7万条/秒，RocketMQ在阿里使用在淘宝支付宝端，在处理异步消息需要保证消息到达，所以未实现api级别批量发送消息</li>
</ul>
<h2 id="单机支持的队列数">单机支持的队列数</h2>
<ul>
<li>Kafka单机超过64个队列/分区，Load会发生明显的飙高现象，队列越多，load越高，发送消息响应时间变长。</li>
<li>RocketMQ单机支持最高5万个队列，Load不会发生明显变化</li>
</ul>
<h2 id="严格的消息顺序">严格的消息顺序</h2>
<ul>
<li>Kafka支持消息顺序，但是一台Broker宕机后，就会产生消息乱序</li>
<li>RocketMQ支持严格的消息顺序，在顺序消息场景下，一台Broker宕机后，发送消息会失败，但是不会乱序</li>
</ul>
<h2 id="分布式事务消息">分布式事务消息</h2>
<ul>
<li>Kafka不支持分布式事务消息</li>
<li>阿里云MQ支持分布式事务消息，未来开源版本的RocketMQ也有计划支持分布式事务消息</li>
</ul>
<h2 id="消息查询">消息查询</h2>
<ul>
<li>Kafka不支持消息查询</li>
<li>RocketMQ支持根据Message Id查询消息，也支持根据消息内容查询消息（发送消息时指定一个Message Key，任意字符串，例如指定为订单Id）</li>
</ul>
<blockquote>
<p>总结：消息查询对于定位消息丢失问题非常有帮助，例如某个订单处理失败，是消息没收到还是收到处理出错了。</p>
</blockquote>
<h2 id="消息回溯">消息回溯</h2>
<ul>
<li>Kafka理论上可以按照Offset来回溯消息</li>
<li>RocketMQ支持按照时间来回溯消息，精度毫秒，例如从一天之前的某时某分某秒开始重新消费消息</li>
</ul>
<blockquote>
<p>总结：典型业务场景如consumer做订单分析，但是由于程序逻辑或者依赖的系统发生故障等原因，导致今天消费的消息全部无效，需要重新从昨天零点开始消费，那么以时间为起点的消息重放功能对于业务非常有帮助。</p>
</blockquote>
<h2 id="消费并行度">消费并行度</h2>
<ul>
<li>Kafka的消费并行度依赖Topic配置的分区数，如分区数为10，那么最多10台机器来并行消费（每台机器只能开启一个线程），或者一台机器消费（10个线程并行消费）。即消费并行度和分区数一致。</li>
<li>RocketMQ消费并行度分两种情况
<ul>
<li>顺序消费方式并行度同Kafka完全一致</li>
<li>乱序方式并行度取决于Consumer的线程数，如Topic配置10个队列，10台机器消费，每台机器100个线程，那么并行度为1000。</li>
</ul>
</li>
</ul>
<h2 id="broker端消息过滤">Broker端消息过滤</h2>
<ul>
<li>Kafka不支持Broker端的消息过滤</li>
<li>RocketMQ支持两种Broker端消息过滤方式
<ul>
<li>根据Message Tag来过滤，相当于子topic概念</li>
<li>向服务器上传一段Java代码，可以对消息做任意形式的过滤，甚至可以做Message Body的过滤拆分。</li>
</ul>
</li>
</ul>
<h2 id="单机系统可靠性">单机系统可靠性</h2>
<ul>
<li>模拟进程退出</li>
</ul>
<blockquote>
<p>在消息收发过程中，利用Kill -9 命令使Broker进程终止，然后重新启动，得到可靠性数据如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">产品</th>
<th style="text-align:left">刷盘策略</th>
<th style="text-align:left">并发</th>
<th style="text-align:left">tps</th>
<th style="text-align:left">丢失</th>
<th style="text-align:left">重复</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Kafka</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">3</td>
<td style="text-align:left">600</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">不重复</td>
</tr>
<tr>
<td style="text-align:left">Kafka</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">30</td>
<td style="text-align:left">10500</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">不重复</td>
</tr>
<tr>
<td style="text-align:left">Kafka</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">150</td>
<td style="text-align:left">49200</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">重复7条</td>
</tr>
<tr>
<td style="text-align:left">RocketMQ</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">1</td>
<td style="text-align:left">4066</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">不重复</td>
</tr>
<tr>
<td style="text-align:left">RocketMQ</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">3</td>
<td style="text-align:left">10900</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">不重复</td>
</tr>
<tr>
<td style="text-align:left">RocketMQ</td>
<td style="text-align:left">异步</td>
<td style="text-align:left">140</td>
<td style="text-align:left">52428</td>
<td style="text-align:left">不丢</td>
<td style="text-align:left">不重复</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在Broker进程被终止重启，Kafka和RMQ都能保证同步发送的消息不丢，因为进程退出后操作系统能确保将该进程遗留在内存的数据刷到磁盘上。实验中，Kafka出现了极少量的消息重复。再次可以确定此场景中，二者的可靠性都很高。</p>
</blockquote>
<ul>
<li>模拟机器掉电</li>
</ul>
<blockquote>
<p>在消息收发过程中，直接拔掉Broker所在的宿主机电源，然后重启宿主机和Broker应用。因受到机房断电限制，我们在本场景测试中使用的是普通PC机器。得到可靠性数据如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>产品</th>
<th>刷盘策略</th>
<th>并发</th>
<th>tps</th>
<th>丢失</th>
<th>重复</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kafka</td>
<td>异步</td>
<td>5</td>
<td>2000</td>
<td>丢失3条</td>
<td>掉电前所有发送重新消费</td>
</tr>
<tr>
<td>Kafka</td>
<td>同步</td>
<td>5</td>
<td>300</td>
<td>不丢</td>
<td>重复3条</td>
</tr>
<tr>
<td>Kafka</td>
<td>同步</td>
<td>60</td>
<td>500</td>
<td>不丢</td>
<td>重复2w条</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>异步</td>
<td>5</td>
<td>2500</td>
<td>丢失19条</td>
<td>不重复</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>同步</td>
<td>5</td>
<td>800</td>
<td>不丢</td>
<td>掉电前所有发送重新消费</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>同步</td>
<td>60</td>
<td>4000</td>
<td>不丢</td>
<td>掉电前所有发送重新消费</td>
</tr>
</tbody>
</table>
<p>###测试结论</p>
<blockquote>
<ol>
<li>在Broker进程被Kill的场景， Kafka和RocketMQ都能在保证吞吐量的情况下，不丢消息，可靠性都比较高。</li>
<li>在宿主机掉电的场景，Kafka与RocketMQ均能做到不丢消息，此时Kafka的吞吐量会急剧下跌，几乎不可用。RocketMQ则仍能保持较高的吞吐量。</li>
<li>在单机可靠性方面，RocketMQ综合表现优于Kafka。</li>
</ol>
</blockquote>
    </section>
</article>
<section class="read-more">
    
    <div class="read-more-item">
        <span class="read-more-item-dim">最近的文章</span>
        <h2 class="post-list__post-title post-title"><a href="/posts/ssh-telnet/" title="link to 自动登录ssh或telnet脚本">自动登录ssh或telnet脚本</a></h2>
        <p class="excerpt"><blockquote>
<p>闲来无事，正好更新下以前写的脚本，自动登录ssh或telnet。
而且也方便记录密码。<a href="http://git.oschina.net/sohunjug/connect.sh">Git-oschina</a>、<a href="https://github.com/sohunjug/connect.sh">GitHub</a></p>
</blockquote>
<h2 id="使用connectsh自动连接ssh或者telnet">使用connect.sh自动连接ssh或者telnet</h2>&hellip;</p>
        <div class="post-list__meta">
            <time datetime=" 2016-08-08 09:10:28 &#43;0800" class="post-list__meta--date date">2016-08-08</time>
             <span class="post-list__meta--tags tags">   • <a href="https://sohunjug.com/tags/ssh">ssh</a>   • <a href="https://sohunjug.com/tags/telnet">telnet</a>  </span> 
            <a class="btn-border-small" href="/posts/ssh-telnet/">继续阅读</a>
        </div>
    </div>
    


    
    <div class="read-more-item">
        <span class="read-more-item-dim">更早的文章</span>
        <h2 class="post-list__post-title post-title"><a href="/posts/c-define/" title="link to C/C&#43;&#43;中宏定义的用法">C/C&#43;&#43;中宏定义的用法</a></h2>
        <p class="excerpt"><p>无论是在网络上还是项目中，define的用法非常广泛，define是由预处理程序自动完成的，被成为宏定义。</p>
<p>宏定义的作用范围仅限于当前文件(头文件除外，包含该头文件的源文件中都可使用)，一般define分为有参数和无参数两种。</p>
<h1 id="宏定义优点">宏定义优点</h1>&hellip;</p>
        <div class="post-list__meta">
            <time datetime=" 2016-08-08 09:10:28 &#43;0800" class="post-list__meta--date date">2015-01-13</time>
             
            <span class="post-list__meta--tags tags"> 
                  • <a href="https://sohunjug.com/tags/define">Define</a>   • <a href="https://sohunjug.com/tags/c/c&#43;&#43;">C/C&#43;&#43;</a>  
            </span>
            
            <a class="btn-border-small" href="/posts/c-define/">继续阅读</a>
        </div>
    </div>
    
 </section>
 
<section class="post-comments">
    
      <div id="disqus_thread"></div>
      <script>
      
      var disqus_config = function () {
          this.page.url = "https:\/\/sohunjug.com\/posts\/kafka-rocketmq\/";
          this.page.identifier = "https:\/\/sohunjug.com\/posts\/kafka-rocketmq\/";
      };
  
      var disqus_shortname = 'sohunjug';
      
      (function() { 
          var d = document, s = d.createElement('script');
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>To view comments from<a href="http://disqus.com/?ref_noscript"> Disqus </a>, please enable JavaScript.</noscript>
      
    

    
    
  </section>
  

        <section class="footer">
    <footer>
        <span class="footer__copyright">&copy; 2013-2023, By sohunjug  备案号：<a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备14034266号</a></span>
        <span class="footer__copyright">本站点内容基于 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 协议发布。</span>
        <span class="footer__copyright">由 <a href="https://gohugo.io/">Hugo</a> 于 2023-01-05 生成， 采用 <a href="https://github.com/xslingcn/vno-hugo"> Vno - Hugo</a> 作为主题。</span>
    </footer>
</section>


    </div>
  </div>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script><script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'your_ga_id', 'your_host');
    ga('send', 'pageview');
</script>

  
</body>

